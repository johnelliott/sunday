---
- hosts: minisunday
  gather_facts: yes

  vars:
    user: pi
    hostname: minisunday
  vars_files:
    - vars.yml
    
  tasks:
    #- import_tasks: ./tasks/expand-rootfs.yml
    #- import_tasks: ./tasks/tz.yml
    #- import_tasks: ./tasks/hostname.yml
    - import_tasks: ./tasks/packages.yml
    - import_tasks: ./tasks/editor.yml
    - import_tasks: ./tasks/vimrc.yml
    - import_tasks: ./tasks/afpd.yml
    - import_tasks: ./tasks/authorized_keys.yml

    - name: install more packages
      become: true
      apt: pkg={{ item }} update_cache=yes cache_valid_time=3600 state=present
      with_items:
        - motion
        - mpack
        - ssmtp
        - ddclient
        - natpmp-utils

    - name: enable camera
      become: yes
      lineinfile:
        path: /etc/modules-load.d/modules.conf
        line: bcm2835-v4l2 
        create: yes
      notify: restart motion

    - name: motion conf
      become: yes
      template:
        dest: /etc/motion/motion.conf
        src: templates/motion.conf.j2
        owner: root
      notify: restart motion

    - name: ddclient conf
      become: yes
      template:
        dest: /etc/ddclient.conf
        src: templates/ddclient.conf.j2
        owner: root
      notify: restart ddclient

    - name: ssh config
      become: yes
      template:
        dest: /home/{{ user }}/.ssh/config
        src: templates/ssh-config.j2
        owner: root

    - name: ssh keys
      copy:
        src: ~/.ssh/{{ item }}
        dest: /home/{{ user }}/.ssh/{{ item }}
        mode: "400"
      with_items:
        - "{{ tunnel_key_name }}"
        - "{{ tunnel_key_name }}.pub"

    - name: copy systemd services
      become: yes
      copy:
        owner: root
        dest: /etc/systemd/system/sunday-{{ item }}
        src: files/{{ item }}
      with_items:
        - portfwd-asker@.service
        - portfwd-asker@22.timer
        - portfwd-tunnel.service
      notify: restart sunday-services

    - name: enable services
      become: yes
      systemd:
        name: "{{ item }}"
        enabled: yes
        daemon_reload: true
      with_items:
        - ddclient
        - motion
        - sunday-portfwd-asker@22.timer
        - sunday-portfwd-tunnel.service

    - name: start services
      become: yes
      systemd:
        name: "{{ item }}"
        state: started
        daemon_reload: true
      with_items:
        - ddclient
        - motion
        - sunday-portfwd-asker@22.timer
        - sunday-portfwd-tunnel.service

  handlers:
    # TODO fix
    #- name: restart sunday-services
    #  systemd:
    #    name: sunday-services
    #    state: restarted

    - name: restart ddclient
      systemd:
        name: ddclient
        state: reloaded

    - name: restart motion
      systemd:
        name: motion
        state: reloaded
